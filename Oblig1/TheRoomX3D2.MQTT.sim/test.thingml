import "datatypes.thingml" from stl
import "pim.thingml"
import "javatimer.thingml"
import "timestuff.thingml"

thing Test includes TemperatureMsg, GeneralMsg, OnOffMsg, LuminanceMsg {
	// Sim
    required port toMQTT {
		sends temperature,
			  luminance
			  
		receives SwitchOn,
			  	 SwitchOff
	} 
	
	// Human
    required port send_cmd {
		sends SwitchOn, SwitchOff, set_temperature, set_delta, fetch_temp
	}

	// Human
	provided port get_values {
		receives temperature, prompt
	}

	property prefered_temp: Integer = 23
	property temp_diff: Integer = 2
	property temp_night_diff: Integer = 8
	
	property test_temp:Double	
	
	property lum_on: Integer = 100
	property lum_off: Integer = 5
	
	property isnight:Boolean

    statechart test_behavior init prompt_enter {
		on entry do
			println("T: Start test")
			isnight = false
			send_cmd!set_temperature(prefered_temp)
		end
		
        state prompt_enter {
			transition -> day_and_light_on
			event prompt_value:get_values?prompt
			guard prompt_value.txt == "Now entering thermostat. Please give temperature observations "
			action do 
				println("T: Correct value")
			end
        }

		state day_and_light_on {
			on entry do 
				toMQTT!temperature(1, "", 15)
			end

			transition -> some_time_later_1
			event switch:toMQTT?SwitchOn
			guard switch.did == 1
			action do 
				println("T1: Switch on")
			end
		}

		state some_time_later_1 {
			on entry do 
				toMQTT!temperature(1, "", 25)
			end

			transition -> day_and_light_off
			event switch:toMQTT?SwitchOff
			guard switch.did == 1
			action do 
				println("T2: Switch off")
			end
		}

		state day_and_light_off {
			on entry do 
				toMQTT!temperature(1, "", 15)
				toMQTT!luminance(1, lum_off)
			end

			transition -> some_time_later_2
			event switch:toMQTT?SwitchOn
			guard switch.did == 1
			action do 
				println("T3: Switch on")
			end
		}

		state some_time_later_2 {
			on entry do 
				toMQTT!temperature(1, "", 20)
			end

			transition -> night_start
			event switch:toMQTT?SwitchOff
			guard switch.did == 1
			action do 
				println("T4: Switch off")
			end
		}

		state night_start {
			on entry do
				// Set to night
				toMQTT!temperature(1, "", 10)
			end

			transition -> some_time_later_3
			event switch:toMQTT?SwitchOn
			guard switch.did == 1
			action do 
				println("T5: Switch on")
			end
		}

		state some_time_later_3 {
			on entry do 
				toMQTT!temperature(1, "", 14)
			end

			transition -> day_start
			event switch:toMQTT?SwitchOff
			guard switch.did == 1
			action do 
				println("T6: Switch off")
			end
		}

		state day_start {
			on entry do 
				// Set to day
				isnight = false
			end

			transition -> end_test
			event switch:toMQTT?SwitchOn
			guard switch.did == 1
			action do 
				println("T7: Switch on")
			end
		}

		state end_test {
			on entry do
				println("T9: Success")
			end
		}
    }
}